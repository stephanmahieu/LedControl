<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LED Control</title>
    <link rel="stylesheet" href="/css/jquery.mobile-1.4.5.min.css">
    <link rel="stylesheet" href="/css/ledcontrol.css" type="text/css">
    <script src="/javascript/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="/javascript/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
</head>

<body>
<script type="text/javascript">
    let websocket;

    $(document).ready(function(){
        let dimObj = $("#dim");
        let dimSwitchObj = $("#manual-dim");
        let statusObj = $('#input-status');

        dimObj.on("slidestop vclick", dimChangeHandler);

        // set initial state flipswitch to Automatic (off)
        dimSwitchObj.val('off').flipswitch('refresh');

        dimSwitchObj.on("change", dimSwitchChangeHandler);

        $(".effect").click(effectChangeHandler);

        // status / reset
        $(".common").click(function(event) {
            $.get("/rest/api/" + $(this)[0].id);
        });

        $("#command").click(function(event) {
            $.get("/rest/api/command/" + 'Hello-world!');
        });

        $("#debugOn").click(function(event) {
            $.get("/rest/api/debug/true");
        });

        $("#debugOff").click(function(event) {
            $.get("/rest/api/debug/false");
        });


        // Open a WebSocket connection.
        let wsUri = getWebSocketRootUri() + "/websocket-pub";
        websocket = new WebSocket(wsUri);

        // Connected to server
        websocket.onopen = function(ev) {
            statusObj.text('Connected to server');
        };

        // Connection close
        websocket.onclose = function(ev) {
            statusObj.text('Disconnected from server');
        };

        // Error
        websocket.onerror = function(ev) {
            statusObj.text(ev.data);
        };

        // Message Received
        websocket.onmessage = function(ev) {
            if (ev.data === "keep-alive") {
                //websocket.send("echo-alive");
                return;
            }

            let msgClass = "";
            if (ev.data.match("^INT:")) {
                msgClass = "debug";
            } else if (ev.data.match("^INJ:")) {
                msgClass = "received";
            } else if (ev.data.match("^OUT:")) {
                msgClass = "sent";
            }

            let msg = $('<div>').addClass("inputdata " + msgClass).text(ev.data);
            $('#input').append(msg);

            // use received status (json) to update the controls to reflect the current state
            let indexAcc = ev.data.indexOf('{');
            if (indexAcc >= 0) {
                let jsonData = ev.data.substring(indexAcc);
                let json = $.parseJSON(jsonData);
                if ('STATUS' === json.type && json.status) {
                    let status = json.status;
                    if (status.effect) {
                        let effectNo = effectToInt(json.status.effect);
                        $(".current-effect").removeClass("current-effect");
                        $("#" + effectNo).addClass("current-effect");
                    }
                    if (status.brightness) {
                        if (dimObj.val() !== status.brightness) {
                            // prevent triggering the changehandler and send a dim command!
                            dimObj
                                .off('slidestop vclick')
                                .val(status.brightness).slider("refresh")
                                .on('slidestop vclick', dimChangeHandler);
                        }
                    }
                    if (status.autoBrightness === false) {
                        // manual == on
                        if ('off' === dimSwitchObj.val()) {
                            // prevent triggering the changehandler and send a command!
                            dimSwitchObj
                                .off("change")
                                .val('on').flipswitch('refresh')
                                .on("change", dimSwitchChangeHandler);
                        }
                        dimObj.slider('enable');
                    } else {
                        // automatic == off
                        if ('on' === dimSwitchObj.val()) {
                            // prevent triggering the changehandler and send a command!
                            dimSwitchObj
                                .off("change")
                                .val('off').flipswitch('refresh')
                                .on("change", dimSwitchChangeHandler);

                        }
                        dimObj.slider('disable');
                    }
                }
            }

            if (!isTouchDevice() && isStickingToBottom()) {
                scrollToBottom();
            }
        };
    });

    function dimSwitchChangeHandler() {
        let dimObj = $("#dim");
        if ( $("#manual-dim").val() === 'on') {
            dimObj.slider('enable');
            let value = dimObj.val();
            $.get('/rest/api/dim/' + value);
        } else {
            dimObj.slider('disable');
            $.get('/rest/api/dim/' + "auto");
        }
    }

    function dimChangeHandler() {
        let value = $("#dim").val();
        $.get('/rest/api/dim/' + value);
    }

    function effectChangeHandler(event) {
        let effectId = event.currentTarget.id;
        $.get('/rest/api/effect/' + effectId);
        $(".current-effect").removeClass("current-effect");
        event.currentTarget.classList.add("current-effect");
    }

    function getWebSocketRootUri() {
        return "ws://" + (document.location.hostname === "" ? "localhost" : document.location.hostname) + ":9292";
    }

    function isTouchDevice() {
        try {
            document.createEvent("TouchEvent");
            return true;
        } catch(e) {
            return false;
        }
    }

    function scrollToBottom() {
        let inputObj = $("#input");
        let scrollHeight = inputObj.prop("scrollHeight");
        //$('#input').scrollTop(scrollHeight);
        inputObj.animate({scrollTop: scrollHeight}, 150);
    }

    function isStickingToBottom() {
        let inputObj =  $("#input");
        let scrollHeight = inputObj.prop("scrollHeight");
        let innerHeight = inputObj.innerHeight();
        let scrollMaxPos = scrollHeight - innerHeight;
        let scrollPos = inputObj.scrollTop();
        return (scrollMaxPos - scrollPos) < 25;
    }

    function effectToInt(name) {
        switch (name) {
            case "Blank": return 0;
            case "RainbowMarch": return 1;
            case "SoftTwinkles": return 2;
            case "ColorTwinkles": return 3;
            case "DutchFlag": return 4;
            case "Cylon": return 5;
            case "Pride2015demo": return 6;
            case "DiscoStrobe": return 7;
            case "Gradient": return 8;
            case "AntiAlias": return 9;
            case "Fireworks": return 10;
            case "RunningDot": return 11;
            case "Ripple": return 12;
            default: return 1;
        }
    }
</script>

<div data-role="page">
    <div data-role="header" data-theme="a">
        <h1>LED control</h1>
    </div>

    <div data-role="content">

        <table>
            <tr>
                <td><a href="#" id="status" class="common" data-role="button" data-theme="b" data-inline="true">Get Status</a></td>
                <td><a href="#" id="reset" class="common" data-role="button" data-theme="b" data-inline="true">Reset Arduino</a></td>

                <td><a href="#" id="command" class="special" data-role="button" data-theme="b" data-inline="true">Send command</a></td>
            </tr>
            <tr>
                <td>
                    <div id="flipswitchWrapper">
                        <select name="manual-dim" id="manual-dim" data-role="flipswitch">
                            <option value="on">Brightness Manual</option>
                            <option value="off">Brightness Auto</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <label for="dim" class="ui-hidden-accessible">Brightness:</label>
                    <input type="range" name="dim" id="dim" value="50" min="1" max="255" data-highlight="true" disabled="disabled">
                </td>
            </tr>
            <tr>
                <td><a href="#" id="0" class="effect" data-role="button" data-theme="b" data-inline="true">Blank</a></td>
                <td><a href="#" id="1" class="effect" data-role="button" data-theme="b" data-inline="true">Rainbow March</a></td>
                <td><a href="#" id="2" class="effect" data-role="button" data-theme="b" data-inline="true">Soft Twinkles</a></td>
            </tr>
            <tr>
                <td><a href="#" id="3" class="effect" data-role="button" data-theme="b" data-inline="true">Color Twinkles</a></td>
                <td><a href="#" id="4" class="effect" data-role="button" data-theme="b" data-inline="true">Dutch Flag</a></td>
                <td><a href="#" id="5" class="effect" data-role="button" data-theme="b" data-inline="true">Cylon</a></td>
            </tr>
            <tr>
                <td><a href="#" id="6" class="effect" data-role="button" data-theme="b" data-inline="true">Pride 2015 demo</a></td>
                <td><a href="#" id="7" class="effect" data-role="button" data-theme="b" data-inline="true">Disco Strobe</a></td>
                <td><a href="#" id="8" class="effect" data-role="button" data-theme="b" data-inline="true">Gradient</a></td>
            </tr>
            <tr>
                <td><a href="#" id="9" class="effect" data-role="button" data-theme="b" data-inline="true">AntiAlias bar</a></td>
                <td><a href="#" id="10" class="effect" data-role="button" data-theme="b" data-inline="true">Fireworks</a></td>
                <td><a href="#" id="11" class="effect" data-role="button" data-theme="b" data-inline="true">Running dot</a></td>
            </tr>
            <tr>
                <td><a href="#" id="12" class="effect" data-role="button" data-theme="b" data-inline="true">Ripple</a></td>
            </tr>
        </table>
        <table style="width: 100%">
            <tr>
                <td style="width: 100%">
                    <div id="input-container">
                        <div id="input-header">
                            <div id="input-title">Monitor</div><div id="input-status">Not connected</div>
                        </div>
                        <div id="input"></div>
                    </div>
                </td>
                <td>
                    <a href="#" id="debugOn" class="special" data-role="button" data-theme="b" data-inline="true">Debug On</a>
                    <a href="#" id="debugOff" class="special" data-role="button" data-theme="b" data-inline="true">Debug Off</a>
                </td>
            </tr>
        </table>
    </div>

    <div data-role="footer">
        <h4>LED Control</h4>
    </div>

</div>

</body>
</html>